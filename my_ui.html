<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Tester dashboard</title>

</head>
<style>
    html {
        font-family: Arial, Helvetica, sans-serif
    }

    .sensor_container {
        background-color: aliceblue;
        margin: 5px;

    }

    .sensor_prop {
        display: inline-block;
        min-width: 110px;
    }

    .sensor_val {
        display: inline-block;
    }
</style>

<body>
    <div>
        <span>ip address</span>
        <input id='ipaddr' type="text">
        <div id="status">not connected.</div>
    </div>
    <button id="connect">Connect</button>
    <h2>TEST INFO</h2>
    <div id="test_data"></div>
    <h2>ATOM INFO</h2>
    <div id="atom_data"></div>
    <h2>SENSOR DATA</h2>
    <div id="sensor_data">
    </div>

    <script>
        // connect button
        let button = document.getElementById("connect");
        button.onclick = connect;
        // connection status
        let connection_status = document.getElementById("status");
        // ip address input
        let ip_input = document.getElementById("ipaddr");
        // keeps track of the key_value containers.
        var atom_data = {};
        var sensor_data = {};
        var test_data = {}
        // key-value containers are put in here.
        var sensor_div = document.getElementById("sensor_data");
        var test_div = document.getElementById("test_data");
        var atom_div = document.getElementById("atom_data");

        function make_url() {
            let url = "ws://" + ip_input.value + ":8567/ws"
            console.log(url);
            return url
        }
        var ws;

        function open_socket(url) {
            ws = new WebSocket(url);
            ws.onopen = function (event) {
                console.log('connection opened.')
                connection_status.innerHTML = "connected.";
                init();
            }
            ws.onclose = function (event) {
                console.log('connection closed.')
                connection_status.innerHTML = "closed."
            }
            ws.onmessage = function (event) {
                var _js = JSON.parse(event.data);
                parse_sensor(_js);
            }

        }

        function clear_data(){
            sensor_data={};
            atom_data={};
            test_data={}
            sensor_div.innerHTML="";
            test_div.innerHTML="";
            atom_div.innerHTML="";
        }

        function init() {
            ws.send('atom') // Get cached atom data.
            ws.send('test') // Get cached sensor data.
        }

        function connect(e) {
            if (ws){ws.close()}
            clear_data();
            connect.innerHTML = "connecting"
            open_socket(make_url());
        }


        function PropertyElement() {
            // A property value container.
            this.prop = document.createElement("div");
            this.prop.className = "sensor_prop";
            this.val = document.createElement("div");
            this.val.className = "sensor_val";
            this.container = document.createElement("div");
            this.container.className = "sensor_container";
            this.container.appendChild(this.prop);
            this.container.appendChild(this.val);

        }
        PropertyElement.prototype.update = function (key, value) {
            this.prop.innerHTML = key;
            this.val.innerHTML = value['v'];
        }

        function AtomElement() {
            PropertyElement.call(this);
        }
        AtomElement.prototype = Object.create(PropertyElement.prototype);
        AtomElement.prototype.constructor = PropertyElement;
        AtomElement.prototype.update = function (key, value) {
            if (key ==="reference_data"){
                this.val.innerHTML = JSON.stringify(value['v']);
            }
            else{
                this.val.innerHTML = value['v'];
            }
            this.prop.innerHTML = key;
            
        }

        function TestElement() {
            PropertyElement.call(this);
        }
        TestElement.prototype = Object.create(PropertyElement.prototype);
        TestElement.prototype.constructor = PropertyElement;
        TestElement.prototype.update = function (key, value) {
            this.prop.innerHTML = key;
            this.val.innerHTML = value['v']
        }


        function parse_data(data, data_container, data_div, property_element) {
            for (const [key, value] of Object.entries(data)) {
                var el = data_container[key];
                if (el == undefined) {
                    var el = new property_element();
                    data_container[key] = el;
                    data_div.appendChild(el.container);

                }
                el.update(key, value);
                console.log(key, value);
            }
        }

        function parse_sensor(data) {
            let subj = data["subj"];
            delete data.subj;
            if (subj === "sensor_data") {
                //Sensor data.
                parse_data(data, sensor_data, sensor_div, PropertyElement)
            } else if (subj === "atom_warmup") {
                //Atom data.
                parse_data(data, atom_data, atom_div, AtomElement)
            } else if (subj === "test_warmup") {
                //Test data.
                parse_data(data, test_data, test_div, TestElement)
            } else if (subj ==="atom_executing"){
                parse_data(data,atom_data,atom_div,AtomElement)
            }


        }
        var params = new URLSearchParams(window.location.search)
        let _server = params.get("server");
        if (_server){
            ip_input.value=_server;
        }
        
        //open_socket();
    </script>
</body>

</html>